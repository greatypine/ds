<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.guoanshequ.dc.das.dao.master.CustomerMapper">


	<select id="queryFirst" parameterType="java.util.Map" resultType="java.util.Map">
        <![CDATA[
            SELECT * FROM (
			SELECT T.emplyeeno,SUM(CASE WHEN (DATE_FORMAT(T.`firstdate`,'%Y-%m' ) =#{yearmonth}) THEN
			1 ELSE 0 END ) AS datacount
			FROM (
					SELECT thc.id AS customerid, tc.employee_no AS emplyeeno, thc.one_date AS firstdate
					FROM t_customer tc
					LEFT JOIN (select thc2.id,thc2.house_id,thc2.customer_id,thc2.one_pay,thc2.six_pay,thc2.one_date,thc2.six_date,thc2.third_grade_pay,thc2.third_grade_date from (select max(id) as id from t_house_customer GROUP BY customer_id) thc1 INNER JOIN t_house_customer thc2 on thc1.id=thc2.id) thc ON tc.id = thc.customer_id
					WHERE DATE_FORMAT(thc.one_date, '%Y-%m') =#{yearmonth}			
				) T
			WHERE T.emplyeeno != '' AND T.emplyeeno IS NOT NULL AND T.emplyeeno NOT LIKE 'T%'
			GROUP BY T.emplyeeno
			HAVING datacount > 0 ) st_customer
		]]>
		<where>
		   <if test="null != employee_no and null != employee_no">
               <![CDATA[                   
                   emplyeeno = #{employee_no}
               ]]>
           </if>
        </where>
	</select>	
	
	<select id="querySecond" parameterType="java.util.Map" resultType="java.util.Map">
        <![CDATA[
        SELECT * FROM (
			SELECT	T.emplyeeno,SUM(CASE WHEN (DATE_FORMAT(T.`seconddate`,'%Y-%m' ) = #{yearmonth}) THEN
						1 ELSE 0 END ) AS datacount
			FROM (
					SELECT thc.id AS customerid, tc.employee_no AS emplyeeno, thc.six_date AS seconddate
					FROM t_customer tc
					LEFT JOIN (select thc2.id,thc2.house_id,thc2.customer_id,thc2.one_pay,thc2.six_pay,thc2.one_date,thc2.six_date,thc2.third_grade_pay,thc2.third_grade_date from (select max(id) as id from t_house_customer GROUP BY customer_id) thc1 INNER JOIN t_house_customer thc2 on thc1.id=thc2.id) thc ON tc.id = thc.customer_id
					WHERE	DATE_FORMAT(thc.six_date, '%Y-%m') = #{yearmonth} 			
				) T
			WHERE T.emplyeeno != '' AND T.emplyeeno IS NOT NULL AND T.emplyeeno NOT LIKE 'T%'
			GROUP BY T.emplyeeno
			HAVING datacount > 0 ) st_customer
		]]>
	    <where>
		   <if test="null != employee_no and null != employee_no">
               <![CDATA[                   
                   emplyeeno = #{employee_no}
               ]]>
           </if>
        </where>
	</select>
	
	<select id="queryThird" parameterType="java.util.Map" resultType="java.util.Map">
        <![CDATA[
        SELECT * FROM (
			SELECT T.emplyeeno,SUM(CASE WHEN (DATE_FORMAT(T.`thirddate`,'%Y-%m' ) = #{yearmonth}) THEN
						1 ELSE 0 END ) AS datacount
			FROM (
					SELECT thc.id AS customerid, tc.employee_no AS emplyeeno, thc.third_grade_date AS thirddate
					FROM t_customer tc
					LEFT JOIN (select thc2.id,thc2.house_id,thc2.customer_id,thc2.one_pay,thc2.six_pay,thc2.one_date,thc2.six_date,thc2.third_grade_pay,thc2.third_grade_date from (select max(id) as id from t_house_customer GROUP BY customer_id) thc1 INNER JOIN t_house_customer thc2 on thc1.id=thc2.id) thc ON tc.id = thc.customer_id
					WHERE	DATE_FORMAT(thc.third_grade_date, '%Y-%m') = #{yearmonth} 			
				) T
			WHERE T.emplyeeno != '' AND T.emplyeeno IS NOT NULL AND T.emplyeeno NOT LIKE 'T%'
			GROUP BY T.emplyeeno
			HAVING datacount > 0 ) st_customer
		]]>
		<where>
		   <if test="null != employee_no and null != employee_no">
               <![CDATA[                   
                   emplyeeno = #{employee_no}
               ]]>
           </if>
        </where>
	</select>

		<select id="queryFirstByStore" parameterType="java.util.Map" resultType="java.util.Map">
        <![CDATA[
			SELECT 
				store_id,
				storename,
				sum(datacount) as datacount 
				from (
			SELECT 
				t_store.store_id,
				t_store.`name` as storename,
			SUM(CASE WHEN (DATE_FORMAT(T.`firstdate`,'%Y-%m' ) =#{yearmonth}) THEN
			    1 ELSE 0 END ) AS datacount
			FROM (
					SELECT thc.id AS customerid, tc.employee_no AS emplyeeno, thc.one_date AS firstdate
					FROM t_customer tc
					LEFT JOIN (select thc2.id,thc2.house_id,thc2.customer_id,thc2.one_pay,thc2.six_pay,thc2.one_date,thc2.six_date,thc2.third_grade_pay,thc2.third_grade_date from (select max(id) as id from t_house_customer GROUP BY customer_id) thc1 INNER JOIN t_house_customer thc2 on thc1.id=thc2.id) thc ON tc.id = thc.customer_id
					WHERE DATE_FORMAT(thc.one_date, '%Y-%m') = #{yearmonth}			
				) T
			LEFT JOIN tb_bizbase_user on tb_bizbase_user.employeeId = T.emplyeeno
			LEFT JOIN t_store on t_store.store_id = tb_bizbase_user.store_id
			WHERE T.emplyeeno != '' AND T.emplyeeno IS NOT NULL AND T.emplyeeno NOT LIKE 'T%'
			GROUP BY T.emplyeeno
			HAVING datacount>0 ) t1
			GROUP BY store_id,storename
		]]>
	</select>	
	
	<select id="querySecondByStore" parameterType="java.util.Map" resultType="java.util.Map">
        <![CDATA[
			SELECT 
				store_id,
				storename,
				sum(datacount) as datacount 
				from (
			SELECT
				t_store.store_id,
				t_store.`name` as storename,
				T.emplyeeno,SUM(CASE WHEN (DATE_FORMAT(T.`seconddate`,'%Y-%m' ) = #{yearmonth}) THEN
						1 ELSE 0 END ) AS datacount
			FROM (
					SELECT thc.id AS customerid, tc.employee_no AS emplyeeno, thc.six_date AS seconddate
					FROM t_customer tc
					LEFT JOIN (select thc2.id,thc2.house_id,thc2.customer_id,thc2.one_pay,thc2.six_pay,thc2.one_date,thc2.six_date,thc2.third_grade_pay,thc2.third_grade_date from (select max(id) as id from t_house_customer GROUP BY customer_id) thc1 INNER JOIN t_house_customer thc2 on thc1.id=thc2.id) thc ON tc.id = thc.customer_id
					WHERE	DATE_FORMAT(thc.six_date, '%Y-%m') = #{yearmonth} 			
				) T
			LEFT JOIN tb_bizbase_user on tb_bizbase_user.employeeId = T.emplyeeno
			LEFT JOIN t_store on t_store.store_id = tb_bizbase_user.store_id
			WHERE T.emplyeeno != '' AND T.emplyeeno IS NOT NULL AND T.emplyeeno NOT LIKE 'T%'
			GROUP BY T.emplyeeno
			HAVING datacount > 0 ) t2
			GROUP BY store_id,storename

		]]>
	</select>
	
	<select id="queryThirdByStore" parameterType="java.util.Map" resultType="java.util.Map">
        <![CDATA[
			SELECT 
				store_id,
				storename,
				sum(datacount) as datacount 
			from (
			SELECT
				t_store.store_id,
				t_store.`name` as storename,
				T.emplyeeno,SUM(CASE WHEN (DATE_FORMAT(T.`thirddate`,'%Y-%m' ) = #{yearmonth}) THEN
						1 ELSE 0 END ) AS datacount
			FROM (
					SELECT thc.id AS customerid, tc.employee_no AS emplyeeno, thc.third_grade_date AS thirddate
					FROM t_customer tc
					LEFT JOIN (select thc2.id,thc2.house_id,thc2.customer_id,thc2.one_pay,thc2.six_pay,thc2.one_date,thc2.six_date,thc2.third_grade_pay,thc2.third_grade_date from (select max(id) as id from t_house_customer GROUP BY customer_id) thc1 INNER JOIN t_house_customer thc2 on thc1.id=thc2.id) thc ON tc.id = thc.customer_id
					WHERE	DATE_FORMAT(thc.third_grade_date, '%Y-%m') = #{yearmonth} 			
				) T
			LEFT JOIN tb_bizbase_user on tb_bizbase_user.employeeId = T.emplyeeno
			LEFT JOIN t_store on t_store.store_id = tb_bizbase_user.store_id
			WHERE T.emplyeeno != '' AND T.emplyeeno IS NOT NULL AND T.emplyeeno NOT LIKE 'T%'
			GROUP BY T.emplyeeno
			HAVING datacount>0 ) t3
			GROUP BY store_id,storename
		]]>
	</select>
	
</mapper>