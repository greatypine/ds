<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.guoanshequ.dc.das.dao.slave.UserMemberMapper">

	<!-- 根据创建时间从收款表中获取社员信息，黄金社员associator_level为2的数据 -->
	<select id="queryUserMemberByCreateTime" parameterType="java.util.Map" resultType="java.util.Map">
        <![CDATA[
		select 
			tc.id as customer_id,
			torp.store_id as regist_storeid,
			torp.type as member_type,
			tc.mobilephone as mobilephone,
			tc.create_time as regist_time,
			tc.associator_level as associator_level,
			tc.associator_expiry_date as associator_expiry_date,
			torp.pay_time as opencard_time
		from t_customer tc
		left join t_order_receipts torp  on (torp.customer_id = tc.id and torp.pay_status ='payed' and (torp.type = 'associator_start_2' OR torp.type = 'associator_up_2' OR torp.type='plus'))
		where ((tc.create_time >=#{begintime} and tc.create_time <=#{endtime} ) 
		or ( tc.update_time >=#{begintime} and tc.update_time <=#{endtime} ))
		and tc.associator_level = 2 
		]]>
	</select>
	
	
	<!-- 根据创建时间从收款表中获取社员信息，试用黄金社员 associator_level为-2的数据-->
	<select id="queryUserMemberByLevelTime" parameterType="java.util.Map" resultType="java.util.Map">
        <![CDATA[
			select 
				tc.id as customer_id,
				tc.mobilephone as mobilephone,
				tc.create_time as regist_time,
				tc.associator_level as associator_level,
				tc.associator_expiry_date as associator_expiry_date
			from t_customer tc
			where ((tc.create_time >=#{begintime} and tc.create_time <=#{endtime} ) 
			or ( tc.update_time >=#{begintime} and tc.update_time <=#{endtime} ))
			and tc.associator_level = #{level} 
		]]>
	</select>
	
	<!-- 根据custore_id从收款表中查询注册门店、支付时间，获取(试用)社员的最新信息-->
	<select id="queryRegistInfoByCusIdOftry2" parameterType="String" resultType="OrderReceiptsEntity">
        <![CDATA[
			select 
				torp.store_id ,
				torp.type ,
				torp.pay_time 
			from  t_order_receipts torp
			where torp.customer_id= #{customer_id}
			and torp.pay_status ='payed' and torp.type = 'associator_start_-2'
			order by torp.create_time desc 
			limit 1 
		]]>
	</select>
	
	<!-- 根据custore_id从收款表中查询注册门店、支付时间，获取社员的最新信息-->
	<select id="queryRegistInfoByCusIdOf2" parameterType="String" resultType="OrderReceiptsEntity">
        <![CDATA[
			select 
				torp.store_id ,
				torp.type ,
				torp.pay_time 
			from  t_order_receipts torp
			where torp.customer_id= #{customer_id}
			and torp.pay_status ='payed' and (torp.type = 'associator_start_2' OR torp.type = 'associator_up_2' OR torp.type='plus')
			order by torp.create_time desc 
			limit 1 
		]]>
	</select>
	
	
	<!-- 统计时间段内每个城市取消的订单 -->
	<select id="queryCancelOrderCityByCreateTime" parameterType="java.util.Map" resultType="java.util.Map">
        <![CDATA[
			select 
				tmpaa.canceldate,
				tmpaa.city_code,
				a.name as city_name,
				tmpaa.cancelcount
			from (        
				select 
					date(tof.create_time) canceldate,
					ts.city_code as city_code,
					count(order_id) cancelcount 
				from t_order_flow tof
				join t_order tor on (tor.id = tof.order_id)
				join t_eshop te on (te.id = tor.eshop_id)
				join t_store ts on (tor.store_id = ts.id and ts.white!='QA' AND ts.`status`=0)
				where tof.create_time >=#{begintime} and tof.create_time <=#{endtime} 
					and tof.order_status ='cancel'
					and te.super_member = 'yes'
				group by date(tof.create_time),ts.city_code
			) tmpaa
			left join t_sys_area a on (tmpaa.city_code = a.code and a.level = 2)
		]]>
	</select>
	
	<!-- 统计企业集采社员用户，并不会体现在付款表中，只是用户手动填写信息到mongo,以申请码的方式所成为2的会员 -->
	<select id="queryStoreIdOfGroupByCusid" parameterType="String" resultType="java.util.Map">
        <![CDATA[
			select tcard.customer_id,tcard.type,tbatch.store_id from t_card tcard
			join t_exchange_card_batch tbatch on (tcard.batch_id = tbatch.id)
			where customer_id =#{customer_id} 
			limit 1;
		]]>
	</select>
	
	<!-- 统计企业集采社员用户，并不会体现在付款表中，只是用户手动填写信息到mongo,以申请码的方式所成为2的会员 -->
	<select id="queryCityNoByStoreid" parameterType="String" resultType="String">
        <![CDATA[
			select city_code as regist_cityno from t_store where id = #{store_id}
		]]>
	</select>
	
	
</mapper>