<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.guoanshequ.dc.das.dao.slave.StoreTradeChannelMapper">


	<select id="queryStoreTradeChannels" parameterType="java.util.Map"
		resultType="java.util.Map">
        <![CDATA[
	SELECT
	    a.`name` AS city_name,
	    ts.`name` AS store_name,
	    IFNULL(tor.dep_name,'') AS dep_name, 
	    IFNULL(tor.channel_name,'') AS channel_name,
	    SUM(IFNULL(tor.price,0.00)) AS order_amount,
	    COUNT(tor.group_id) AS order_count,
	    ts.id AS platformid
	FROM t_store ts
	LEFT JOIN  t_sys_area a on ts.city_code = a.code and a.level = 2
	LEFT JOIN
		(
			SELECT
				tor_in.store_id, tesr.id AS channel_id, tesr.role_name AS role_name,
				LEFT(tesr.role_name,POSITION('_' IN tesr.role_name)-1) AS channel_name,
				SUBSTRING(tesr.role_name,POSITION('_' IN tesr.role_name)+1) AS dep_name,
				IFNULL(IF(tor_in.is_split='yes',tor_in.trading_price/tog.order_quantity,tor_in.trading_price),0.0)  AS price,
				tor_in.group_id
			FROM t_eshop te
			JOIN t_order tor_in ON te.id=tor_in.eshop_id
		    JOIN t_order_group  tog ON  tog.id=tor_in.group_id
		    JOIN t_order_receipts trp ON (trp.eshop_id = te.id and trp.`status` =0 and (trp.pay_platform !='prepay' OR tor_in.business_model_id != '4662527ec28f4a84abfceefa61557d0c'))
				JOIN t_order_flow tof ON tor_in.id=tof.order_id
					AND tof.order_status='signed'
					AND tof.create_time>=DATE(#{begindate})
					AND tof.create_time<DATE_ADD(DATE(#{enddate}), INTERVAL 1 DAY)
				LEFT JOIN t_ed_sys_role tesr ON tesr.id=te.department_id
					AND tesr.role_name LIKE '%\_%'
				WHERE te.`name` NOT LIKE '%测试%' AND te.white!='QA' 
			) tor ON ts.id=tor.store_id
		WHERE tor.store_id IS NOT NULL
		    AND ts.white!='QA' AND ts.`status`=0
		    AND ts.number IN (${storeids})
		GROUP BY tor.store_id, tor.channel_id
		]]>
	</select>
</mapper>